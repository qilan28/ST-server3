<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜é¢æ¿ - SillyTavern ç®¡ç†å¹³å°</title>
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
    <meta name="description" content="å…¬ç›Šäº‘é…’é¦†å¤šå¼€ç®¡ç†å¹³å° - SillyTavernå®ä¾‹ç®¡ç†ç³»ç»Ÿ">
    <meta name="theme-color" content="#4a69bd">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/table-fix.css">
    <link rel="stylesheet" href="/css/loading.css">
    <link rel="stylesheet" href="/css/admin-runtime-limit.css">
    <!-- æƒé™éªŒè¯è„šæœ¬ (å¿…é¡»æ”¾åœ¨æœ€å‰é¢) -->
    <script src="/js/auth-check.js"></script>
    
    <!-- ç½‘ç»œè¯·æ±‚åè®®å¤„ç†å·¥å…·åœ¨headä¸­å…ˆåŠ è½½ -->
    <script src="/js/protocol-helper.js"></script>
    <script>
        // ç¡®ä¿ä½¿ç”¨å®‰å…¨è¯·æ±‚
        if (window.protocolHelper) {
            console.log('åè®®å¸®æ‰‹åŠ è½½æˆåŠŸï¼Œå½“å‰åè®®: ' + window.protocolHelper.detectCurrentProtocol());
        } else {
            console.warn('åè®®å¸®æ‰‹æœªåŠ è½½ï¼Œå¯èƒ½å­˜åœ¨åè®®ä¸åŒ¹é…é—®é¢˜');
        }
    </script>
    <script src="/js/apply-site-settings.js"></script>
    <script src="/js/fix-site-settings.js"></script>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆªåŒº -->
        <div class="admin-header-buttons">
            <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                <!-- æ·»åŠ Logo -->
                <div class="header-logo-container">
                    <img src="/logo.png" alt="Logo" class="site-logo">
                    <h2 style="color: #4a5568;">ç®¡ç†å‘˜é¢æ¿</h2>
                </div>
                
                <!-- ç”¨æˆ·ä¿¡æ¯å’Œæ“ä½œæŒ‰é’® -->
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <img id="adminUserAvatar" src="" alt="å¤´åƒ" style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                        <span id="adminUsername" style="color: #4a5568; font-weight: 600;"></span>
                    </div>
                    <a href="/dashboard.html" id="backToDashboard" class="btn btn-secondary" style="display: none;">è¿”å›ç”¨æˆ·é¢æ¿</a>
                    <button onclick="logout()" class="btn btn-danger">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </div>
        
        <main class="main">
            <!-- åˆ·æ–°æ§åˆ¶ -->
            <div style="display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button onclick="manualRefresh()" class="btn btn-secondary" title="ç«‹å³åˆ·æ–°æ•°æ®">ğŸ”„ åˆ·æ–°</button>
                    <div>
                        <label for="refreshIntervalSelect" style="margin-right: 10px; white-space: nowrap;">è‡ªåŠ¨åˆ·æ–°é—´éš”ï¼š</label>
                        <select id="refreshIntervalSelect" class="form-input" style="width: auto;" onchange="handleRefreshIntervalChange()">
                            <option value="0">å…³é—­</option>
                            <option value="10000">10 ç§’</option>
                            <option value="15000">15 ç§’</option>
                            <option value="30000" selected>30 ç§’</option>
                            <option value="60000">1 åˆ†é’Ÿ</option>
                            <option value="300000">5 åˆ†é’Ÿ</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span>åˆ·æ–°çŠ¶æ€ï¼š</span>
                    <span id="refreshStatusIndicator" class="status-badge status-running">30ç§’</span>
                </div>
            </div>
            <!-- ç®¡ç†å‘˜è¯´æ˜ -->
            <div class="info-banner" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-left: 4px solid #5a67d8; padding: 15px 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <p style="margin: 0; color: #ffffff; font-size: 14px;">
                    <strong>ğŸ”§ ç®¡ç†å‘˜é¢æ¿è¯´æ˜ï¼š</strong> æ­¤é¢æ¿ä»…ç”¨äºç³»ç»Ÿç®¡ç†ã€‚ç®¡ç†å‘˜è´¦æˆ·ä¸åŒ…å« SillyTavern å®ä¾‹ã€‚å¦‚éœ€ä½¿ç”¨ SillyTavernï¼Œè¯·æ³¨å†Œä¸€ä¸ªæ™®é€šç”¨æˆ·è´¦æˆ·ã€‚
                </p>
            </div>

            <!-- ç³»ç»Ÿç»Ÿè®¡ -->
            <div class="stats-card">
                <h2>ğŸ“Š ç³»ç»Ÿç»Ÿè®¡</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                        <div class="stat-value" id="totalUsers">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ç®¡ç†å‘˜</div>
                        <div class="stat-value" id="adminUsers">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æ™®é€šç”¨æˆ·</div>
                        <div class="stat-value" id="regularUsers">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">è¿è¡Œä¸­å®ä¾‹</div>
                        <div class="stat-value" id="runningInstances">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">å·²åœæ­¢å®ä¾‹</div>
                        <div class="stat-value" id="stoppedInstances">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æ€»CPUä½¿ç”¨</div>
                        <div class="stat-value" id="totalCpu">0%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æ€»å†…å­˜ä½¿ç”¨</div>
                        <div class="stat-value" id="totalMemory">0 MB</div>
                    </div>
                </div>
            </div>

            <!-- é…ç½®ç®¡ç† -->
            <div class="stats-card">
                <h2>âš™ï¸ ç³»ç»Ÿé…ç½®</h2>
                <div id="configMessage" class="message"></div>
                
                <!-- ç«™ç‚¹è®¾ç½® -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0; color: #2d3748; font-size: 16px;">ğŸŒ ç½‘ç«™è®¾ç½®</h3>
                    <div id="siteSettingsMessage" class="message" style="margin-bottom: 15px; display: block; padding: 10px;"></div>
                    
                    <!-- æ·»åŠ åŠ¨ç”»æ ·å¼ -->
                    <style>
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                        
                        #saveSiteSettings:disabled {
                            cursor: wait;
                        }
                        
                        .message.success {
                            background-color: #dcfce7;
                            color: #15803d;
                            border: 1px solid #86efac;
                        }
                        
                        .message.error {
                            background-color: #fee2e2;
                            color: #b91c1c;
                            border: 1px solid #f87171;
                        }
                        
                        .message.info {
                            background-color: #e0f2fe;
                            color: #0369a1;
                            border: 1px solid #7dd3fc;
                        }
                    </style>
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600;">
                                é¡¹ç›®åç§°
                            </label>
                            <input type="text" id="projectName" class="form-input" placeholder="å…¬ç›Šäº‘é…’é¦†å¤šå¼€ç®¡ç†å¹³å°">
                            <small style="display: block; margin-top: 5px; color: #718096;">
                                æ˜¾ç¤ºåœ¨å„ä¸ªé¡µé¢çš„æ ‡é¢˜ã€å¸¦å®½ç­‰å¤„
                            </small>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600;">
                                ç½‘ç«™åç§°
                            </label>
                            <input type="text" id="siteName" class="form-input" placeholder="SillyTavern å¤šå¼€ç®¡ç†å¹³å°">
                            <small style="display: block; margin-top: 5px; color: #718096;">
                                æ˜¾ç¤ºåœ¨æµè§ˆå™¨æ ‡ç­¾é¡µç­‰å¤„
                            </small>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600;">
                                ç”¨æˆ·æ•°é‡é™åˆ¶
                            </label>
                            <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                                <input type="number" id="maxUsers" class="form-input" placeholder="0" min="0" style="flex-grow: 1;">
                                <button type="button" id="saveMaxUsers" class="btn btn-primary" onclick="saveMaxUsers()" style="white-space: nowrap;">ä»…ä¿å­˜æ­¤é¡¹</button>
                            </div>
                            <small style="display: block; margin-top: 5px; color: #718096;">
                                æœ€å¤§å…è®¸æ³¨å†Œçš„ç”¨æˆ·æ•°é‡ï¼Œè®¾ç½®ä¸º 0 è¡¨ç¤ºæ— é™åˆ¶
                            </small>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600;">
                                ç½‘ç«™å›¾æ ‡
                            </label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <img id="currentFavicon" src="/favicon.ico" alt="å½“å‰å›¾æ ‡" style="width: 32px; height: 32px; border: 1px solid #e2e8f0;">
                                <div style="flex-grow: 1;">
                                    <!-- æœ¬åœ°æ–‡ä»¶ä¸Šä¼  -->
                                    <form id="faviconForm" enctype="multipart/form-data" style="display: flex; gap: 10px; margin-bottom: 10px;">
                                        <input type="file" id="faviconFile" class="form-input" accept="image/png,image/jpeg,image/gif,image/x-icon" style="flex-grow: 1;">
                                        <button type="button" id="uploadFavicon" class="btn btn-primary">ä¸Šä¼ </button>
                                    </form>
                                    <small style="display: block; margin-top: 5px; margin-bottom: 10px; color: #718096;">
                                        æ”¯æŒ PNG, JPG, GIF, ICO æ ¼å¼ï¼Œæœ€å¤§ 1MB
                                    </small>
                                    
                                    <!-- URLå›¾æ ‡è®¾ç½® -->
                                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                                        <input type="text" id="faviconUrl" class="form-input" placeholder="è¾“å…¥å›¾æ ‡URLåœ°å€..." style="flex-grow: 1;">
                                        <button type="button" id="setFaviconUrl" class="btn btn-primary">è®¾ç½®</button>
                                    </div>
                                    <small style="display: block; margin-top: 5px; color: #718096;">
                                        ä¹Ÿå¯ä»¥ç›´æ¥è¾“å…¥å›¾æ ‡URLåœ°å€ï¼Œå¦‚ https://example.com/favicon.ico
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button id="saveSiteSettings" type="button" class="btn btn-primary" onclick="directSaveSettings()">ä¿å­˜ç½‘ç«™è®¾ç½®</button>
                        </div>
                        
                        <script>
                            // ç›´æ¥ä¿å­˜å‡½æ•°ï¼Œç»•è¿‡å¤æ‚çš„äº‹ä»¶å¤„ç†
                            function directSaveSettings() {
                                try {
                                    // æ˜¾ç¤ºæ­£åœ¨ä¿å­˜çš„æ¶ˆæ¯
                                    const message = document.getElementById('siteSettingsMessage');
                                    message.textContent = 'æ­£åœ¨ä¿å­˜è®¾ç½®...';
                                    message.style.backgroundColor = '#e0f2fe';
                                    message.style.color = '#0369a1';
                                    message.style.display = 'block';
                                    
                                    // è·å–è¡¨å•æ•°æ®
                                    const projectName = document.getElementById('projectName').value;
                                    const siteName = document.getElementById('siteName').value;
                                    
                                    // å‘é€ AJAX è¯·æ±‚
                                    const xhr = new XMLHttpRequest();
                                    // ä½¿ç”¨åè®®å¸®æ‰‹è·å–å®‰å…¨çš„URL
                                    const apiUrl = window.protocolHelper ? 
                                        window.protocolHelper.getApiUrl('/api/site-settings') : 
                                        '/api/site-settings';
                                    console.log('å‘é€è¯·æ±‚åˆ°:', apiUrl, 'å½“å‰åè®®:', window.location.protocol);
                                    
                                    xhr.open('PUT', apiUrl, true);
                                    xhr.setRequestHeader('Content-Type', 'application/json');
                                    xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.getItem('token'));
                                    
                                    xhr.onload = function() {
                                        if (xhr.status === 200) {
                                            message.textContent = 'è®¾ç½®å·²ä¿å­˜æˆåŠŸ!';
                                            message.style.backgroundColor = '#dcfce7';
                                            message.style.color = '#15803d';
                                        } else {
                                            message.textContent = 'ä¿å­˜å¤±è´¥: ' + xhr.responseText;
                                            message.style.backgroundColor = '#fee2e2';
                                            message.style.color = '#b91c1c';
                                        }
                                    };
                                    
                                    xhr.onerror = function() {
                                        message.textContent = 'ç½‘ç»œé”™è¯¯: æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨';
                                        message.style.backgroundColor = '#fee2e2';
                                        message.style.color = '#b91c1c';
                                        message.style.display = 'block';
                                    };
                                    
                                    xhr.send(JSON.stringify({
                                        project_name: projectName,
                                        site_name: siteName
                                    }));
                                } catch (e) {
                                    console.error('ä¿å­˜è¿‡ç¨‹å‘ç”Ÿé”™è¯¯:', e);
                                    const message = document.getElementById('siteSettingsMessage');
                                    if (message) {
                                        message.textContent = 'é”™è¯¯: ' + e.message;
                                        message.style.backgroundColor = '#fee2e2';
                                        message.style.color = '#b91c1c';
                                        message.style.display = 'block';
                                    }
                                }
                            }
                        </script>
                    </div>
                </div>
                
                <!-- Nginx é…ç½® -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;" class="nginx-settings">
                    <h3 style="margin-top: 0; color: #2d3748; font-size: 16px;">ğŸŒ Nginx åå‘ä»£ç†é…ç½®</h3>
                    <div id="nginxConfigMessage" class="message" style="margin-bottom: 10px; display: none;"></div>
                    <div class="loading-indicator" style="margin-bottom: 10px; display: none; text-align: center; padding: 10px; background: #f7fafc; border-radius: 4px;">
                        <div class="spinner" style="display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(102, 126, 234, 0.3); border-radius: 50%; border-top-color: #667eea; animation: spin 1s linear infinite; margin-right: 8px;"></div>
                        æ­£åœ¨åŠ è½½ Nginx é…ç½®...
                    </div>
                    
                    <!-- åŸºæœ¬è®¾ç½® -->
                    <div style="display: grid; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600;">
                                å¯ç”¨ Nginx æ¨¡å¼
                            </label>
                            <label class="switch">
                                <input type="checkbox" id="nginxEnabled">
                                <span class="slider"></span>
                            </label>
                            <small style="display: block; margin-top: 5px; color: #718096;">
                                å¯ç”¨åï¼Œè®¿é—®åœ°å€æ ¼å¼ä¸ºï¼šhttp://åŸŸå/ç”¨æˆ·å/st
                            </small>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600;">
                                åŸŸå
                            </label>
                            <input type="text" id="nginxDomain" class="form-input" placeholder="ä¾‹å¦‚ï¼šyourdomain.com">
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600;">
                                ç«¯å£
                            </label>
                            <input type="number" id="nginxPort" class="form-input" placeholder="80" min="1" max="65535">
                            <small style="display: block; margin-top: 5px; color: #718096;">
                                é»˜è®¤ HTTP ç«¯å£ä¸º 80ï¼ŒHTTPS ç«¯å£ä¸º 443
                            </small>
                        </div>
                    </div>
                    
                    <!-- é«˜çº§è®¾ç½® -->
                    <div style="background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; font-size: 15px; color: #1e40af;">ğŸ”§ é«˜çº§é…ç½®</h4>
                            <button id="toggleAdvancedBtn" class="btn btn-sm btn-secondary" style="font-size: 12px; padding: 4px 8px;">æ˜¾ç¤ºé«˜çº§é€‰é¡¹</button>
                        </div>
                        
                        <div id="advancedSettings" style="display: none;">
                            <div style="display: grid; gap: 15px;">
                                <!-- é…ç½®æ¨¡æ¿é€‰æ‹© -->
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600;">
                                        é…ç½®æ¨¡æ¿
                                    </label>
                                    <select id="nginxTemplate" class="form-input">
                                        <option value="basic">åŸºç¡€åå‘ä»£ç†</option>
                                        <option value="advanced">é«˜çº§åå‘ä»£ç†(é™æ€æ–‡ä»¶ç¼“å­˜)</option>
                                        <option value="https">HTTPS é…ç½®</option>
                                        <option value="multiuser">å¤šç”¨æˆ·æ¨¡å¼</option>
                                    </select>
                                </div>
                                
                                <!-- SSLè¯ä¹¦è·¯å¾„ -->
                                <div id="sslCertOptions" style="display: none;">
                                    <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600;">
                                        SSL è¯ä¹¦è·¯å¾„
                                    </label>
                                    <input type="text" id="sslCertPath" class="form-input" placeholder="/etc/letsencrypt/live/yourdomain.com/fullchain.pem">
                                    <small style="display: block; margin-top: 5px; color: #718096;">
                                        Let's Encrypt è¯ä¹¦é€šå¸¸åœ¨ /etc/letsencrypt/live/åŸŸå/ ç›®å½•ä¸‹
                                    </small>
                                </div>
                                
                                <!-- æ—¥å¿—ç›®å½• -->
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #4a5568; font-weight: 600;">
                                        æ—¥å¿—ç›®å½•
                                    </label>
                                    <input type="text" id="nginxLogDir" class="form-input" placeholder="/var/log/nginx" value="/var/log/nginx">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- é…ç½®é¢„è§ˆ -->
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; font-size: 15px; color: #1e40af;">ğŸ” é…ç½®é¢„è§ˆ</h4>
                            <button id="refreshPreviewBtn" class="btn btn-sm btn-secondary" style="font-size: 12px; padding: 4px 8px;">åˆ·æ–°é¢„è§ˆ</button>
                        </div>
                        <div style="background: #1a202c; border-radius: 6px; padding: 10px; overflow-x: auto;">
                            <pre id="nginxConfigPreview" style="margin: 0; color: #e2e8f0; font-family: monospace; font-size: 12px; line-height: 1.4;">
# ç‚¹å‡»â€œåˆ·æ–°é¢„è§ˆâ€æŒ‰é’®æŸ¥çœ‹ Nginx é…ç½®é¢„è§ˆ
                            </pre>
                        </div>
                    </div>
                    
                    <!-- æŒ‰é’®ç»„ -->
                    <div style="display: flex; gap: 10px;">
                        <button id="saveNginxConfigBtn" onclick="saveNginxConfig()" class="btn btn-primary">ä¿å­˜é…ç½®</button>
                        <button id="generateNginxConfigBtn" onclick="generateNginxConfig()" class="btn btn-secondary">ç”Ÿæˆé…ç½®æ–‡ä»¶</button>
                        <button id="testNginxConfigBtn" onclick="testNginxConfig()" class="btn btn-secondary">æµ‹è¯•é…ç½®</button>
                    </div>
                </div>
                
                <!-- å®ä¾‹è½¬å‘é…ç½® -->
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;" class="forwarding-settings">
                    <h3 style="margin-top: 0; color: #2d3748; font-size: 16px;">ğŸ”„ å®ä¾‹è½¬å‘é…ç½®</h3>
                    <div id="forwardingConfigMessage" class="message" style="margin-bottom: 10px; display: none;"></div>
                    <div class="loading-indicator" style="margin-bottom: 10px; display: none; text-align: center; padding: 10px; background: #f7fafc; border-radius: 4px;">
                        <div class="spinner" style="display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(102, 126, 234, 0.3); border-radius: 50%; border-top-color: #667eea; animation: spin 1s linear infinite; margin-right: 8px;"></div>
                        æ­£åœ¨åŠ è½½å®ä¾‹è½¬å‘é…ç½®...
                    </div>
                    
                    <!-- åŸºæœ¬è®¾ç½®å·²ç§»é™¤ -->
                    <!-- è½¬å‘æœåŠ¡å™¨åŠŸèƒ½å·²å¯ç”¨ï¼Œæ— éœ€æ‰‹åŠ¨å¼€å…³ -->
                    
                    <!-- æœåŠ¡å™¨åˆ—è¡¨ -->
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; font-size: 15px; color: #1e40af;">ğŸ“‹ è½¬å‘æœåŠ¡å™¨åˆ—è¡¨</h4>
                            <button id="addServerBtn" class="btn btn-sm btn-primary" style="font-size: 12px; padding: 4px 8px;">æ·»åŠ æœåŠ¡å™¨</button>
                        </div>
                        
                        <div class="table-container">
                            <table class="users-table" id="forwardingServersTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>æœåŠ¡å™¨åœ°å€</th>
                                        <th>ç«¯å£</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ·»åŠ æ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="forwardingServersTableBody">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 30px;">åŠ è½½ä¸­...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- è®¿é—®ç¤ºä¾‹ -->
                    <div style="background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h4 style="margin-top: 0; margin-bottom: 10px; font-size: 15px; color: #1e40af;">ğŸ’¡ è®¿é—®ç¤ºä¾‹</h4>
                        <div id="forwardingExampleText">
                            <p style="margin: 5px 0; font-family: monospace;">http://localhost:7091/ç”¨æˆ·å/st/</p>
                        </div>
                    </div>
                    
                    <!-- æŒ‰é’®ç»„ -->
                    <div style="display: flex; gap: 10px;">
                        <button id="refreshForwardingListBtn" class="btn btn-secondary">åˆ·æ–°åˆ—è¡¨</button>
                    </div>
                </div>
            </div>

            <!-- ç”¨æˆ·ç®¡ç† -->
            <div class="users-card">
                <h2>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
                <div id="adminMessage" class="message"></div>
                
                <!-- æœç´¢å·¥å…·æ  -->
                <div class="search-container" style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                    <div style="position: relative; flex-grow: 1;">
                        <input type="text" id="userSearchInput" class="form-input" placeholder="æœç´¢ç”¨æˆ·å/QQã€é‚®ç®±æˆ–ç«¯å£..." style="padding-left: 35px; padding-right: 35px; width: 100%;" title="æ”¯æŒæœç´¢ç”¨æˆ·åã€QQå·ã€é‚®ç®±æˆ–ç«¯å£å·">
                        <span style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #718096;">ğŸ”</span>
                        <button id="clearSearchBtn" type="button" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #718096; cursor: pointer; display: none; font-size: 16px;">âœ•</button>
                    </div>
                    <div id="searchResultCount" style="white-space: nowrap; color: #718096; font-size: 0.9rem;"></div>
                    <select id="userRoleFilter" class="form-input" style="width: auto;">
                        <option value="all">æ‰€æœ‰è§’è‰²</option>
                        <option value="user">åªæ˜¾ç¤ºç”¨æˆ·</option>
                        <option value="admin">åªæ˜¾ç¤ºç®¡ç†å‘˜</option>
                    </select>
                    <select id="userStatusFilter" class="form-input" style="width: auto;">
                        <option value="all">æ‰€æœ‰çŠ¶æ€</option>
                        <option value="running">è¿è¡Œä¸­</option>
                        <option value="stopped">å·²åœæ­¢</option>
                    </select>
                </div>
                
                <div class="table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>ç”¨æˆ·å</th>
                                <th>é‚®ç®±</th>
                                <th>è§’è‰²</th>
                                <th>ç«¯å£</th>
                                <th>æœ€åç™»å½•</th>
                                <th>å®ä¾‹çŠ¶æ€</th>
                                <th>STç‰ˆæœ¬</th>
                                <th>å®‰è£…çŠ¶æ€</th>
                                <th>æ³¨å†Œæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="10" style="text-align: center; padding: 30px;">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- å…¬å‘Šç®¡ç† -->
            <div class="users-card">
                <h2>ğŸ“¢ å…¬å‘Šç®¡ç†</h2>
                <div style="margin-bottom: 20px;">
                    <button onclick="showCreateAnnouncementModal()" class="btn btn-primary">â¡ åˆ›å»ºæ–°å…¬å‘Š</button>
                </div>
                <div class="table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>ç±»å‹</th>
                                <th>æ ‡é¢˜</th>
                                <th>å†…å®¹</th>
                                <th>çŠ¶æ€</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="announcementsTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 30px;">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- å‹æƒ…é“¾æ¥ç®¡ç† -->
            <div class="users-card" id="friendsLinksManagementTab">
                <h2>ğŸ”— å‹æƒ…é“¾æ¥ç®¡ç†</h2>
                <div id="friendsLinkMessage" class="message" style="display: none;"></div>
                <div style="margin-bottom: 20px;">
                    <button id="addFriendLinkBtn" class="btn btn-primary">âœš æ·»åŠ å‹æƒ…é“¾æ¥</button>
                </div>
                <div id="friendsLinksTableContainer" class="table-container loading">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>åç§°</th>
                                <th>é“¾æ¥</th>
                                <th>æè¿°</th>
                                <th>æ’åº</th>
                                <th>çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="friendsLinksTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 30px;">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- å®ä¾‹ç›‘æ§ -->
            <div class="instances-card">
                <h2>ğŸ–¥ï¸ å®ä¾‹ç›‘æ§</h2>
                <div class="table-container">
                    <table class="instances-table">
                        <thead>
                            <tr>
                                <th>ç”¨æˆ·å</th>
                                <th>çŠ¶æ€</th>
                                <th>CPU</th>
                                <th>å†…å­˜</th>
                                <th>è¿è¡Œæ—¶é—´</th>
                                <th>é‡å¯æ¬¡æ•°</th>
                            </tr>
                        </thead>
                        <tbody id="instancesTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 30px;">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- è¿è¡Œæ—¶é•¿é™åˆ¶é…ç½® -->
            <div class="users-card">
                <h2>â± è¿è¡Œæ—¶é•¿é™åˆ¶</h2>
                <div id="runtimeLimitConfig">
                    <div class="loading-indicator">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- è‡ªåŠ¨å¤‡ä»½é…ç½® -->
            <div class="users-card">
                <h2>â° è‡ªåŠ¨å¤‡ä»½é…ç½®</h2>
                <div id="autoBackupMessage" class="message" style="display: none;"></div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="autoBackupEnabled">
                        <span>å¯ç”¨è‡ªåŠ¨å¤‡ä»½</span>
                    </label>
                    <small style="color: #718096; margin-left: 30px;">å®šæ—¶è‡ªåŠ¨å¤‡ä»½æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„ç”¨æˆ·æ•°æ®</small>
                </div>

                <div class="form-group">
                    <label for="backupIntervalHours">å¤‡ä»½é—´éš”ï¼ˆå°æ—¶ï¼‰*</label>
                    <input type="number" id="backupIntervalHours" class="form-input" min="1" max="168" value="24" placeholder="1-168å°æ—¶">
                    <small style="color: #718096;">æœ€å°1å°æ—¶ï¼Œæœ€å¤§168å°æ—¶ï¼ˆ7å¤©ï¼‰</small>
                </div>

                <div class="form-group">
                    <label for="backupType">å¤‡ä»½ç±»å‹ *</label>
                    <select id="backupType" class="form-input">
                        <option value="all">æ‰€æœ‰ç”¨æˆ·</option>
                        <option value="logged_in_today">å½“æ—¥ç™»å½•è¿‡çš„ç”¨æˆ·</option>
                        <option value="running">è¿è¡Œä¸­çš„å®ä¾‹</option>
                    </select>
                    <small style="color: #718096;">åªä¼šå¤‡ä»½å·²é…ç½®HFä¸”å¯ç”¨è‡ªåŠ¨å¤‡ä»½çš„ç”¨æˆ·</small>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="saveAutoBackupConfig()" class="btn btn-primary">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    <button onclick="showAutoBackupUsers()" class="btn btn-secondary">ğŸ‘¥ æŸ¥çœ‹å¤‡ä»½ç”¨æˆ·</button>
                    <button onclick="triggerAutoBackup()" class="btn btn-warning">âš¡ ç«‹å³æ‰§è¡Œ</button>
                </div>

                <div id="autoBackupStatus" style="margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 8px; display: none;">
                    <h3 style="margin: 0 0 10px 0; font-size: 16px;">ğŸ“Š å¤‡ä»½çŠ¶æ€</h3>
                    <div id="autoBackupStatusContent"></div>
                </div>

                <div id="autoBackupUsersList" style="margin-top: 20px; display: none;">
                    <h3 style="margin: 0 0 10px 0;">ç¬¦åˆå¤‡ä»½æ¡ä»¶çš„ç”¨æˆ·</h3>
                    <div id="autoBackupUsersContent"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- å…¬å‘Šåˆ›å»º/ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="announcementModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <h2 id="modalTitle">åˆ›å»ºå…¬å‘Š</h2>
            <form id="announcementForm" onsubmit="handleAnnouncementSubmit(event)">
                <input type="hidden" id="announcementId">
                <div class="form-group">
                    <label for="announcementType">å…¬å‘Šç±»å‹ *</label>
                    <select id="announcementType" class="form-input" required>
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="login">ç™»å½•é¡µå…¬å‘Š</option>
                        <option value="dashboard">ç”¨æˆ·é¢æ¿å…¬å‘Š</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="announcementTitle">æ ‡é¢˜ *</label>
                    <input type="text" id="announcementTitle" class="form-input" required placeholder="è¾“å…¥å…¬å‘Šæ ‡é¢˜" maxlength="100">
                </div>
                <div class="form-group">
                    <label for="announcementContent">å†…å®¹ *</label>
                    <textarea id="announcementContent" class="form-input" required placeholder="è¾“å…¥å…¬å‘Šå†…å®¹" rows="6" maxlength="500"></textarea>
                    <small style="color: #718096;">æœ€å¤š500å­—</small>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="announcementIsActive" checked>
                        <span>ç«‹å³å¯ç”¨</span>
                    </label>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    <button type="button" onclick="closeAnnouncementModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å‹æƒ…é“¾æ¥æ·»åŠ /ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="friendLinkModal" class="custom-modal">
        <div class="modal-overlay"></div>
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="friendLinkModalTitle" class="modal-title">æ·»åŠ å‹æƒ…é“¾æ¥</h3>
                <span class="modal-close" onclick="hideModal('friendLinkModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="friendLinkForm">
                    <div class="form-group">
                        <label for="friendLinkName">åç§° *</label>
                        <input type="text" id="friendLinkName" class="form-input" required placeholder="è¾“å…¥ç½‘ç«™åç§°">
                    </div>
                    <div class="form-group">
                        <label for="friendLinkUrl">URL *</label>
                        <input type="url" id="friendLinkUrl" class="form-input" required placeholder="è¾“å…¥ç½‘ç«™URL (ä»¥http://æˆ–https://å¼€å¤´)">
                    </div>
                    <div class="form-group">
                        <label for="friendLinkLogo">Logo URL</label>
                        <input type="url" id="friendLinkLogo" class="form-input" placeholder="è¾“å…¥Logoå›¾ç‰‡URL (å¯é€‰)">
                        <div id="friendLinkLogoPreview" style="margin-top: 10px; min-height: 40px; display: flex; align-items: center; justify-content: center; border: 1px dashed #ddd; padding: 10px; border-radius: 6px;">
                            <p class="text-muted">æ— Logo</p>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="friendLinkDescription">æè¿°</label>
                        <textarea id="friendLinkDescription" class="form-input" placeholder="è¾“å…¥ç½‘ç«™æè¿° (å¯é€‰)" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="friendLinkSortOrder">æ’åºé¡ºåº</label>
                        <input type="number" id="friendLinkSortOrder" class="form-input" value="0" min="0">
                        <small>æ•°å­—è¶Šå°æ’åºè¶Šé å‰ï¼Œç›¸åŒæ’åºæŒ‰IDå‡åºæ’åˆ—</small>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="friendLinkIsActive" checked>
                            <span>å¯ç”¨çŠ¶æ€</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="hideModal('friendLinkModal')">å–æ¶ˆ</button>
                <button id="friendLinkSaveBtn" class="modal-btn modal-btn-primary" onclick="document.getElementById('friendLinkForm').dispatchEvent(new Event('submit'))">æ·»åŠ </button>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ æœåŠ¡å™¨æ¨¡æ€æ¡† -->
    <div id="serverModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <h2 id="serverModalTitle">æ·»åŠ è½¬å‘æœåŠ¡å™¨</h2>
            <form id="serverForm" onsubmit="handleServerSubmit(event)">
                <input type="hidden" id="serverId">
                <div class="form-group">
                    <label for="serverAddress">æœåŠ¡å™¨åœ°å€ *</label>
                    <input type="text" id="serverAddress" class="form-input" required placeholder="ä¾‹å¦‚ï¼šhttp://localhostï¼Œhttps://8.210.210.211 æˆ– example.com">
                    <small style="display: block; margin-top: 5px; color: #718096;">
                        æ”¯æŒ HTTP/HTTPS URLï¼ˆå¦‚ http://8.210.210.211ï¼‰ã€IP åœ°å€ã€åŸŸåæˆ– localhost
                    </small>
                </div>
                <div class="form-group">
                    <label for="serverPort">ç«¯å£ *</label>
                    <input type="number" id="serverPort" class="form-input" required placeholder="ä¾‹å¦‚ï¼š7092" min="1" max="65535">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="serverIsActive" checked>
                        <span>å¯ç”¨çŠ¶æ€</span>
                    </label>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    <button type="button" onclick="closeServerModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- åè®®æ£€æµ‹ä¸ä¿®å¤å·¥å…·ï¼Œæ”¾åœ¨æœ€å‰é¢ -->
    <script src="/js/protocol-helper.js"></script>
    <!-- å¼ºåˆ¶åˆ·æ–°å·¥å…· -->
    <script src="/js/force-refresh.js"></script>
    <!-- æ¶ˆæ¯å¤„ç†å‡½æ•°å¿…é¡»å…ˆåŠ è½½ -->
    <script src="/js/message-helpers.js"></script>
    <!-- ç®¡ç†é¢æ¿è¾…åŠ©å‡½æ•° -->
    <script src="/js/admin-helpers.js"></script>
    <script src="/js/loading-helpers.js"></script>
    
    <!-- ç¡®ä¿modal.jsåœ¨å‰ï¼ŒshowModal.jsåœ¨ååŠ è½½ -->
    <script src="/js/modal.js"></script>
    <script src="/js/modal-helpers.js"></script>
    <script src="/js/showModal.js"></script>
    <script src="/js/admin.js"></script>
    <script src="/js/user-search.js"></script>
    <script src="/js/site-settings.js"></script>
    <script src="/js/admin-friends.js"></script>
    <!-- Nginxé…ç½®ç›¸å…³è„šæœ¬ -->
    <script src="/js/nginx-templates.js"></script>
    <script src="/js/admin-nginx.js"></script>
    <!-- å®ä¾‹è½¬å‘ç›¸å…³è„šæœ¬ -->
    <script src="/js/admin-forwarding.js"></script>
    <!-- æ–°å¢ä¿®å¤è„šæœ¬ -->
    <script src="/js/admin-fixes.js"></script>
    <!-- è¿è¡Œæ—¶é•¿é™åˆ¶è„šæœ¬ -->
    <script src="/js/admin-runtime-limit.js"></script>
    
    <!-- è°ƒè¯•ä¸è¯Šæ–­å·¥å…·è„šæœ¬å·²ç§»é™¤ -->
</body>
</html>
