<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>控制台 - SillyTavern 多开管理平台</title>
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
    <meta name="description" content="公益云酒馆多开管理平台 - SillyTavern实例管理系统">
    <meta name="theme-color" content="#4a69bd">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/table-fix.css">
    <!-- 权限验证脚本 (必须放在最前面) -->
    <script src="/js/auth-check.js"></script>
    <script src="/js/apply-site-settings.js"></script>
    
    <!-- 多访问地址样式 -->
    <style>
        .alternative-urls {
            margin-top: 10px;
        }
        
        .alternative-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
            margin-top: 8px;
        }
        
        .alternative-url-item {
            margin: 5px 0;
            padding-left: 10px;
            border-left: 2px solid #e2e8f0;
        }
        
        .alternative-url-item a {
            font-size: 0.9em;
            word-break: break-all;
        }
        
        .server-status {
            display: inline-block;
            margin-right: 8px;
            font-size: 0.85em;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .server-status.active {
            color: #48bb78; /* 绿色 */
        }
        
        .server-status.inactive {
            color: #a0aec0; /* 灰色 */
        }
        
        .inactive-link {
            color: #a0aec0; /* 灰色 */
            text-decoration: line-through;
            opacity: 0.8;
        }
    </style>
    <script src="/js/fix-site-settings.js"></script>
</head>
<body>
    <!-- 全局加载指示器 -->
    <div id="globalLoading" class="global-loading">
        <div class="loading-spinner"></div>
        <p>加载中...</p>
    </div>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <div class="header-content">
                <div class="header-logo-container">
                    <img src="/logo.png" alt="Logo" class="site-logo">
                    <h1 class="site-name">SillyTavern 控制台</h1>
                </div>
                <div class="user-info">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <img id="userAvatar" src="" alt="用户头像" style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                        <span id="currentUsername"></span>
                    </div>
                    <a href="/admin.html" id="adminLink" class="btn btn-warning" style="display: none;">
                        👑 管理员面板
                    </a>
                    <button class="btn btn-secondary" onclick="handleLogout()">退出登录</button>
                </div>
            </div>
        </header>

        <main class="dashboard-main">
            <!-- 公告轮播区域 -->
            <div id="dashboardAnnouncementContainer" style="display: none; margin-bottom: 20px;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); position: relative;">
                    <h3 style="margin: 0 0 15px 0; font-size: 18px; display: flex; align-items: center; gap: 10px;">
                        📢 <span id="dashboardAnnouncementTitle"></span>
                    </h3>
                    <p id="dashboardAnnouncementContent" style="margin: 0; line-height: 1.8; font-size: 15px; white-space: pre-wrap;"></p>
                    <small id="dashboardAnnouncementDate" style="display: block; margin-top: 12px; opacity: 0.9; font-size: 13px;"></small>
                    
                    <!-- 轮播控制 -->
                    <div id="dashboardAnnouncementControls" style="display: none; margin-top: 15px; display: flex; align-items: center; justify-content: space-between;">
                        <button onclick="prevDashboardAnnouncement()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-size: 20px; transition: all 0.3s;">❮</button>
                        <div id="dashboardAnnouncementIndicators" style="display: flex; gap: 10px;"></div>
                        <button onclick="nextDashboardAnnouncement()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-size: 20px; transition: all 0.3s;">❯</button>
                    </div>
                </div>
            </div>

            <div class="info-card">
                <h2>实例信息</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="label">用户名：</span>
                        <span class="value" id="username">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">邮箱：</span>
                        <span class="value" id="email">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">端口：</span>
                        <span class="value" id="port">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">状态：</span>
                        <span class="value" id="status">
                            <span class="status-badge status-stopped">已停止</span>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="label">访问地址：</span>
                        <span class="value" id="accessUrlsContainer">
                            <!-- 主访问地址 -->
                            <div>
                                <a id="accessUrl" href="#" target="_blank" class="access-link">-</a>
                            </div>
                            <!-- 备用访问地址列表 -->
                            <div id="alternativeUrls" class="alternative-urls">
                                <!-- 备用地址将在JS中动态生成 -->
                            </div>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="label">创建时间：</span>
                        <span class="value" id="createdAt">-</span>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <h2>实例控制</h2>
                <div class="control-buttons">
                    <button class="btn btn-success" onclick="handleStart()" id="startBtn">
                        ▶️ 启动实例
                    </button>
                    <button class="btn btn-warning" onclick="handleRestart()" id="restartBtn">
                        🔄 重启实例
                    </button>
                    <button class="btn btn-danger" onclick="handleStop()" id="stopBtn">
                        ⏹️ 停止实例
                    </button>
                </div>
                <div id="controlMessage" class="message"></div>
            </div>

            <div class="version-card">
                <h2>📦 版本管理</h2>
                <div class="version-info">
                    <div class="info-item">
                        <span class="label">当前版本：</span>
                        <span class="value" id="currentVersion">-</span>
                    </div>
                    <div class="info-item">
                        <span class="label">安装状态：</span>
                        <span class="value" id="setupStatus">
                            <span class="status-badge">-</span>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="label">依赖状态：</span>
                        <span class="value" id="dependencyStatus">
                            <span class="status-badge">检查中...</span>
                        </span>
                    </div>
                </div>
                
                <div class="version-actions">
                    <button class="btn btn-primary" onclick="showVersionSelector()">
                        🔄 切换版本
                    </button>
                    <button class="btn btn-warning" onclick="handleReinstallDependencies()">
                        📦 重装依赖
                    </button>
                    <button class="btn btn-danger" onclick="handleDeleteVersion()">
                        🗑️ 删除版本
                    </button>
                </div>
                
                <div id="versionMessage" class="message"></div>
                
                <!-- 版本选择器（隐藏） -->
                <div id="versionSelector" class="version-selector" style="display: none;">
                    <h3>选择新版本</h3>
                    <div class="version-list-container">
                        <div class="version-category">
                            <h4>正式版本</h4>
                            <div id="releasesList" class="version-list">加载中...</div>
                        </div>
                        <div class="version-category">
                            <h4>开发分支</h4>
                            <div id="branchesList" class="version-list">加载中...</div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="hideVersionSelector()">取消</button>
                </div>
            </div>

            <div class="backup-card">
                <h2>💾 数据备份</h2>
                <div class="backup-info">
                    <p>将您的 SillyTavern 数据备份到 Hugging Face 仓库</p>
                </div>
                
                <div class="backup-config">
                    <div class="form-group">
                        <label for="hfRepo">Hugging Face Datasets 仓库名 (格式: username/Datasets-name)</label>
                        <input 
                            type="text" 
                            id="hfRepo" 
                            class="form-input" 
                            placeholder="例如: Qilan/sillytavern-backup"
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="hfToken">Hugging Face Token</label>
                        <input 
                            type="password" 
                            id="hfToken" 
                            class="form-input" 
                            placeholder="输入您的 Hugging Face Write Token"
                        >
                        <small style="color: #666; margin-top: 5px; display: block;">
                            获取 Token: <a href="https://huggingface.co/settings/tokens" target="_blank">https://huggingface.co/settings/tokens</a>
                            （需要 Write 权限）
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="hfEmail">Hugging Face 邮箱 ⭐ 必填</label>
                        <input 
                            type="email" 
                            id="hfEmail" 
                            class="form-input" 
                            placeholder="Hugging Face的注册邮箱，例如: user@example.com"
                        >
                        <small style="color: #666; margin-top: 5px; display: block;">
                            用于 Hugging Face Datasets 仓库的身份验证
                        </small>
                    </div>

                    <div class="form-group" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="autoBackupEnabled" onchange="handleAutoBackupToggle()">
                            <span style="font-weight: 600;">⏰ 参与自动备份(管理员设置的时间\小时 备份)</span>
                        </label>
                        <small style="color: #666; margin-top: 8px; display: block; margin-left: 30px;">
                            管理员可以设置定时自动备份。启用后，您的数据将定期自动备份到 HF。<br>
                            <strong style="color: #e53e3e;">注意：</strong>必须先配置 HF 信息才能启用自动备份。
                        </small>
                    </div>
                </div>
                
                <div class="backup-actions">
                    <button class="btn btn-primary" onclick="handleSaveBackupConfig()">
                        💾 保存配置
                    </button>
                    <button class="btn btn-info" onclick="handleTestConnection()">
                        🔌 测试连接
                    </button>
                    <button class="btn btn-success" onclick="handleBackup()">
                        ☁️ 立即备份
                    </button>
                    <button class="btn btn-warning" onclick="handleShowRestorePanel()">
                        📥 恢复备份
                    </button>
                </div>
                
                <div id="backupMessage" class="message"></div>
                
                <div class="backup-status" id="backupStatus" style="display: none;">
                    <h4>备份状态</h4>
                    <div id="backupStatusContent"></div>
                </div>
                
                <div class="backup-logs" id="backupLogsContainer" style="display: none;">
                    <h4>📜 实时日志</h4>
                    <div class="logs-container" id="backupLogs">
                        <div class="empty-logs">等待备份开始...</div>
                    </div>
                </div>
                
                <!-- 恢复备份面板 -->
                <div class="restore-panel" id="restorePanel" style="display: none;">
                    <h4>📥 恢复备份</h4>
                    <div id="restoreMessage" class="message"></div>
                    
                    <div class="restore-list" id="restoreList">
                        <div class="loading">加载备份列表中...</div>
                    </div>
                    
                    <div class="restore-logs" id="restoreLogsContainer" style="display: none;">
                        <h4>📜 恢复日志</h4>
                        <div class="logs-container" id="restoreLogs">
                            <div class="empty-logs">等待恢复开始...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="stats-card">
                <h2>资源使用</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">CPU使用率</div>
                        <div class="stat-value" id="cpuUsage">0%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">内存使用</div>
                        <div class="stat-value" id="memoryUsage">0 MB</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">运行时间</div>
                        <div class="stat-value" id="uptime">0分钟</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">重启次数</div>
                        <div class="stat-value" id="restarts">0</div>
                    </div>
                </div>
            </div>

            <div class="logs-card">
                <h2>📄 实时日志</h2>
                <div class="logs-controls">
                    <div class="log-type-selector">
                        <button class="btn btn-sm" id="outLogBtn" onclick="switchLogType('out')">
                            标准输出
                        </button>
                        <button class="btn btn-sm btn-secondary" id="errorLogBtn" onclick="switchLogType('error')">
                            错误日志
                        </button>
                    </div>
                    <div class="log-actions">
                        <button class="btn btn-sm btn-primary" onclick="refreshLogs()">
                            🔄 刷新
                        </button>
                        <button class="btn btn-sm btn-success" id="autoRefreshBtn" onclick="toggleAutoRefresh()">
                            ▶️ 自动刷新
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="clearLogsDisplay()">
                            🗑️ 清空显示
                        </button>
                    </div>
                </div>
                <div class="logs-info">
                    <span id="logsStatus">日志加载中...</span>
                    <span id="logsTotalLines"></span>
                </div>
                <div class="logs-container" id="logsContainer">
                    <pre id="logsContent">暂无日志</pre>
                </div>
            </div>

            <div class="tips-card">
                <h3>💡 使用提示</h3>
                <ul>
                    <li>首次启动可能需要几秒钟时间，请耐心等待</li>
                    <li>点击访问地址打开您的专属 SillyTavern 实例</li>
                    <li>您的数据存储在独立的目录中，与其他用户完全隔离</li>
                    <li>如遇到问题，可以尝试重启实例或查看错误日志</li>
                    <li>不使用时请停止实例以节省服务器资源</li>
                    <li>日志自动刷新功能可实时查看运行状态</li>
                </ul>
            </div>

            <div class="danger-zone-card">
                <h3>⚠️ 危险操作</h3>
                <div class="danger-zone-content">
                    <div class="danger-zone-warning">
                        <p><strong>删除账号将执行以下操作：</strong></p>
                        <ul>
                            <li>🗑️ 删除您的 SillyTavern 实例</li>
                            <li>🗑️ 删除所有对话记录、角色和设置</li>
                            <li>🗑️ 删除用户数据目录</li>
                            <li>⚠️ 此操作不可恢复！</li>
                        </ul>
                    </div>
                    <button class="btn btn-danger" onclick="handleDeleteAccount()">
                        🗑️ 删除我的账号
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/modal.js"></script>
    <script src="/js/dashboard.js"></script>
</body>
</html>
