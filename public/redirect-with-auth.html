<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­£åœ¨è·³è½¬...</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            padding: 40px;
            text-align: center;
        }

        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        h1 {
            font-size: 24px;
            color: #2d3748;
            margin-bottom: 15px;
        }

        .message {
            color: #4a5568;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .status {
            background: #f7fafc;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            text-align: left;
            margin-top: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 14px;
        }

        .status-label {
            color: #718096;
        }

        .status-value {
            color: #2d3748;
            font-weight: 600;
        }

        .error {
            color: #e53e3e;
            background: #fff5f5;
            border: 1px solid #fc8181;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .btn {
            display: inline-block;
            padding: 12px 30px;
            margin-top: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <h1 id="title">æ­£åœ¨å‡†å¤‡è®¿é—®...</h1>
        <div class="message" id="message">æ­£åœ¨è®¾ç½®èº«ä»½éªŒè¯ä¿¡æ¯ï¼Œè¯·ç¨å€™...</div>
        <div class="status" id="status" style="display: none;">
            <div class="status-item">
                <span class="status-label">ç›®æ ‡åœ°å€:</span>
                <span class="status-value" id="targetUrl">-</span>
            </div>
            <div class="status-item">
                <span class="status-label">Cookie çŠ¶æ€:</span>
                <span class="status-value" id="cookieStatus">æ£€æŸ¥ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">é‡å®šå‘å€’è®¡æ—¶:</span>
                <span class="status-value" id="countdown">-</span>
            </div>
        </div>
        <div class="error" id="error" style="display: none;"></div>
        <a href="/dashboard.html" class="btn" id="backBtn" style="display: none;">è¿”å›æ§åˆ¶å°</a>
    </div>

    <script>
        // è®¾ç½® Cookie
        function setCookie(name, value, days = 365) {
            try {
                document.cookie = `${name}=${value}; path=/; max-age=${days * 24 * 60 * 60}; SameSite=Lax`;
                return document.cookie.includes(`${name}=`);
            } catch (error) {
                console.error('[Cookie] è®¾ç½®å¤±è´¥:', error);
                return false;
            }
        }

        // è·å– URL å‚æ•°
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('title').textContent = 'âŒ è®¿é—®å¤±è´¥';
            document.getElementById('message').textContent = '';
            document.querySelector('.spinner').style.display = 'none';
            document.getElementById('status').style.display = 'none';
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
            document.getElementById('backBtn').style.display = 'inline-block';
        }

        // ä¸»è¦é€»è¾‘
        async function redirectWithAuth() {
            console.log('\n========== [ä¸­è½¬é¡µ] èº«ä»½éªŒè¯è·³è½¬ ==========');
            
            // è·å–ç›®æ ‡ URL
            const targetUrl = getUrlParameter('url');
            if (!targetUrl) {
                showError('ç¼ºå°‘ç›®æ ‡åœ°å€å‚æ•°');
                console.error('[ä¸­è½¬é¡µ] âŒ ç¼ºå°‘ url å‚æ•°');
                return;
            }

            console.log('[ä¸­è½¬é¡µ] ğŸ“ ç›®æ ‡åœ°å€:', targetUrl);
            document.getElementById('targetUrl').textContent = targetUrl;
            document.getElementById('status').style.display = 'block';

            // ä» localStorage è·å– token
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');

            console.log('[ä¸­è½¬é¡µ] ğŸ‘¤ å½“å‰ç”¨æˆ·:', username || 'æœªç™»å½•');
            console.log('[ä¸­è½¬é¡µ] ğŸ”‘ Token çŠ¶æ€:', token ? 'å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');

            if (!token) {
                showError('æœªæ‰¾åˆ°ç™»å½•ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•');
                console.error('[ä¸­è½¬é¡µ] âŒ localStorage ä¸­æ²¡æœ‰ token');
                console.log('==========================================\n');
                return;
            }

            // è®¾ç½® Cookie
            console.log('[ä¸­è½¬é¡µ] ğŸª æ­£åœ¨è®¾ç½® st_token Cookie...');
            document.getElementById('cookieStatus').textContent = 'è®¾ç½®ä¸­...';
            
            const success = setCookie('st_token', token);
            
            if (success) {
                console.log('[ä¸­è½¬é¡µ] âœ… Cookie è®¾ç½®æˆåŠŸ');
                document.getElementById('cookieStatus').textContent = 'âœ… å·²è®¾ç½®';
                document.getElementById('cookieStatus').style.color = '#48bb78';
                
                // éªŒè¯ Cookie
                const cookies = document.cookie;
                console.log('[ä¸­è½¬é¡µ] ğŸª å½“å‰æ‰€æœ‰ Cookies:', cookies);
                
                if (cookies.includes('st_token')) {
                    // å€’è®¡æ—¶è·³è½¬
                    let countdown = 2;
                    document.getElementById('message').textContent = 'èº«ä»½éªŒè¯è®¾ç½®å®Œæˆï¼';
                    document.getElementById('countdown').textContent = countdown + ' ç§’';
                    
                    const timer = setInterval(() => {
                        countdown--;
                        if (countdown > 0) {
                            document.getElementById('countdown').textContent = countdown + ' ç§’';
                        } else {
                            clearInterval(timer);
                            console.log('[ä¸­è½¬é¡µ] ğŸš€ å¼€å§‹è·³è½¬åˆ°:', targetUrl);
                            console.log('==========================================\n');
                            window.location.href = targetUrl;
                        }
                    }, 1000);
                } else {
                    showError('Cookie è®¾ç½®åéªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®');
                    console.error('[ä¸­è½¬é¡µ] âŒ Cookie è®¾ç½®åéªŒè¯å¤±è´¥');
                }
            } else {
                showError('æ— æ³•è®¾ç½®èº«ä»½éªŒè¯ Cookieï¼Œå¯èƒ½è¢«æµè§ˆå™¨é˜»æ­¢ã€‚è¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®æ˜¯å¦å…è®¸ Cookieã€‚');
                console.error('[ä¸­è½¬é¡µ] âŒ setCookie è¿”å› false');
            }
            
            console.log('==========================================\n');
        }

        // é¡µé¢åŠ è½½åæ‰§è¡Œ
        redirectWithAuth();
    </script>
</body>
</html>
