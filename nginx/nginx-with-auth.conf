# Nginx 配置文件 - SillyTavern 多开管理平台
# 终极修复版 3.0 (Cookie Routing + Auth Request + Access Control)
# 新增：JWT Token 权限验证，只有对应用户才能访问自己的实例

user www-data;
worker_processes auto;
pid /run/nginx.pid;

events {
    worker_connections 768;
}

http {
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 100M;
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;

    upstream st_manager { server 127.0.0.1:3000; }
    upstream st_123 { server 127.0.0.1:3001; }
    upstream st_222 { server 127.0.0.1:3002; }

    server {
        listen 7092;
        server_name 119.8.118.149; 

        # =========================================================
        # [Cookie 救援模式] 拦截逃逸的 API 和资源请求
        # =========================================================
        location ~ ^/(api|locales|lib|css|scripts|img|assets|public|data|uploads|fonts|icons|csrf-token|version|node_modules|script\.js|thumbnail) {
            
            # 1. 检查 Cookie：如果是 123 用户，强制送回 123 实例
            if ($cookie_st_context = "123") {
                rewrite ^(.*)$ /123/st$1 last;
            }
            
            # 2. 检查 Cookie：如果是 222 用户，强制送回 222 实例
            if ($cookie_st_context = "222") {
                rewrite ^(.*)$ /222/st$1 last;
            }

            # 3. 备用：Referer 救援 (双重保险)
            if ($http_referer ~* "/123/st/") { rewrite ^(.*)$ /123/st$1 last; }
            if ($http_referer ~* "/222/st/") { rewrite ^(.*)$ /222/st$1 last; }

            # 4. 默认转发给管理端
            proxy_pass http://st_manager;
        }

        # 主服务（管理平台）
        location / {
            proxy_pass http://st_manager;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # =========================================================
        # 用户 123 配置 + 权限验证
        # =========================================================
        
        # 静态资源（需要权限验证）
        location ~ ^/123/st/(scripts|css|lib|img|assets|public|data|uploads|locales)/ {
            # 权限验证
            auth_request /auth-check/123;
            auth_request_set $auth_status $upstream_status;
            
            # 验证失败时返回自定义错误页面
            error_page 401 403 = @access_denied_123;
            
            rewrite ^/123/st/(.*)$ /$1 break;
            proxy_pass http://st_123;
            proxy_http_version 1.1;
            
            add_header Set-Cookie "st_context=123; Path=/; Max-Age=86400; SameSite=Lax";
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            expires 7d;
            proxy_buffering off;
        }

        location = /123/st { return 301 /123/st/; }

        location /123/st/ {
            # 权限验证
            auth_request /auth-check/123;
            auth_request_set $auth_status $upstream_status;
            
            # 验证失败时返回自定义错误页面
            error_page 401 403 = @access_denied_123;
            
            rewrite ^/123/st/(.*)$ /$1 break;
            proxy_pass http://st_123;
            proxy_http_version 1.1;

            add_header Set-Cookie "st_context=123; Path=/; Max-Age=86400; SameSite=Lax";

            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_buffering on;
            proxy_buffer_size 128k;
            proxy_buffers 100 128k;
            proxy_set_header Accept-Encoding "";

            # --- 内容重写 ---
            sub_filter_once off;
            sub_filter_types text/css text/javascript application/javascript application/json;

            sub_filter '<head>' '<head><base href="/123/st/">';
            
            sub_filter '"script.js"' '"/123/st/script.js"';
            sub_filter "'script.js'" "'/123/st/script.js'";
            sub_filter '"/thumbnail' '"/123/st/thumbnail';
            sub_filter "'/thumbnail" "'/123/st/thumbnail";

            sub_filter '"/version' '"/123/st/version';
            sub_filter "'/version" "'/123/st/version";
            sub_filter '"/csrf-token' '"/123/st/csrf-token';
            sub_filter "'/csrf-token" "'/123/st/csrf-token";

            sub_filter 'src="/' 'src="/123/st/';
            sub_filter 'href="/' 'href="/123/st/';
            sub_filter 'action="/' 'action="/123/st/';
            sub_filter 'url(/' 'url(/123/st/';
            sub_filter "src='/" "src='/123/st/";
            sub_filter "href='/" "href='/123/st/";
            
            sub_filter '"/api/' '"/123/st/api/';
            sub_filter "'/api/" "'/123/st/api/";
            
            sub_filter '"/locales/' '"/123/st/locales/';
            sub_filter "'/locales/" "'/123/st/locales/";
            sub_filter '"/lib/' '"/123/st/lib/';
            sub_filter "'/lib/" "'/123/st/lib/";
            sub_filter '"/scripts/' '"/123/st/scripts/';
            sub_filter '"/css/' '"/123/st/css/';
            sub_filter '"/img/' '"/123/st/img/';
            sub_filter '"/assets/' '"/123/st/assets/';
            sub_filter '"/uploads/' '"/123/st/uploads/';

            sub_filter '="/"' '="/123/st/"';
            sub_filter "='/" "='/123/st/";
            
            proxy_redirect / /123/st/;
        }

        # =========================================================
        # 用户 222 配置 + 权限验证
        # =========================================================
        
        location ~ ^/222/st/(scripts|css|lib|img|assets|public|data|uploads|locales)/ {
            # 权限验证
            auth_request /auth-check/222;
            auth_request_set $auth_status $upstream_status;
            
            # 验证失败时返回自定义错误页面
            error_page 401 403 = @access_denied_222;
            
            rewrite ^/222/st/(.*)$ /$1 break;
            proxy_pass http://st_222;
            proxy_http_version 1.1;
            
            add_header Set-Cookie "st_context=222; Path=/; Max-Age=86400; SameSite=Lax";
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            expires 7d;
            proxy_buffering off;
        }

        location = /222/st { return 301 /222/st/; }

        location /222/st/ {
            # 权限验证
            auth_request /auth-check/222;
            auth_request_set $auth_status $upstream_status;
            
            # 验证失败时返回自定义错误页面
            error_page 401 403 = @access_denied_222;
            
            rewrite ^/222/st/(.*)$ /$1 break;
            proxy_pass http://st_222;
            proxy_http_version 1.1;

            add_header Set-Cookie "st_context=222; Path=/; Max-Age=86400; SameSite=Lax";

            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_buffering on;
            proxy_buffer_size 128k;
            proxy_buffers 100 128k;
            proxy_set_header Accept-Encoding "";

            sub_filter_once off;
            sub_filter_types text/css text/javascript application/javascript application/json;

            sub_filter '<head>' '<head><base href="/222/st/">';

            sub_filter '"script.js"' '"/222/st/script.js"';
            sub_filter "'script.js'" "'/222/st/script.js'";
            sub_filter '"/thumbnail' '"/222/st/thumbnail';
            sub_filter "'/thumbnail" "'/222/st/thumbnail";

            sub_filter '"/version' '"/222/st/version';
            sub_filter "'/version" "'/222/st/version";
            sub_filter '"/csrf-token' '"/222/st/csrf-token';
            sub_filter "'/csrf-token" "'/222/st/csrf-token";

            sub_filter 'src="/' 'src="/222/st/';
            sub_filter 'href="/' 'href="/222/st/';
            sub_filter 'action="/' 'action="/222/st/';
            sub_filter 'url(/' 'url(/222/st/';
            sub_filter "src='/" "src='/222/st/";
            sub_filter "href='/" "href='/222/st/";
            
            sub_filter '"/api/' '"/222/st/api/';
            sub_filter "'/api/" "'/222/st/api/";
            
            sub_filter '"/locales/' '"/222/st/locales/';
            sub_filter "'/locales/" "'/222/st/locales/";
            sub_filter '"/lib/' '"/222/st/lib/';
            sub_filter "'/lib/" "'/222/st/lib/";
            sub_filter '"/scripts/' '"/222/st/scripts/';
            sub_filter '"/css/' '"/222/st/css/';
            sub_filter '"/img/' '"/222/st/img/';
            sub_filter '"/assets/' '"/222/st/assets/';
            sub_filter '"/uploads/' '"/222/st/uploads/';

            sub_filter '="/"' '="/222/st/"';
            sub_filter "='/" "='/222/st/";
            
            proxy_redirect / /222/st/;
        }

        # =========================================================
        # 内部验证端点（供 auth_request 使用）
        # =========================================================
        location ~ ^/auth-check/(\w+)$ {
            internal;
            proxy_pass http://st_manager/api/auth-check/verify/$1;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-URI $request_uri;
            
            # 传递 Cookie（包含 JWT token）
            proxy_set_header Cookie $http_cookie;
        }

        # =========================================================
        # 访问被拒绝错误页面
        # =========================================================
        location @access_denied_123 {
            return 302 /access-denied.html?username=123;
        }

        location @access_denied_222 {
            return 302 /access-denied.html?username=222;
        }
    }
}
